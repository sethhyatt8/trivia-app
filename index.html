<!DOCTYPE html>
<html>
<head>
    <title>Freeform Number Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; background: #1a1a1a; color: #f0f0f0; margin: 0; padding: 10px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .container { max-width: 600px; margin: auto; padding: 20px; background: #2a2a2a; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        button { font-size: 1.2rem; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; background: #007bff; color: white; margin: 5px; transition: background-color 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #555; cursor: not-allowed; }
        input { font-size: 1.2rem; padding: 12px; border-radius: 8px; border: 2px solid #555; background: #333; color: #eee; text-align: center; }
        h1, h2, h3 { color: #00bcd4; }
        #question-text { font-size: 1.5rem; margin-bottom: 20px; }
        #timer-display { font-size: 2rem; color: #ffc107; margin-bottom: 20px; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px; margin: 20px auto; }
        .numpad button { height: 60px; font-size: 1.5rem; background: #444; }
        #answer-display { min-height: 40px; background: #111; padding: 10px; border-radius: 8px; font-size: 2rem; margin-bottom: 20px; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #444; }
        th { background: #333; }
        /* Submit button styling to visually separate it from the numpad */
        #submit-button { width: 100%; font-size: 1.1rem; padding: 12px; border-radius: 8px; margin-top: 10px; background: #28a745; }
        #submit-button:hover { background: #1e7e34; }
    </style>
</head>
<body>

    <!-- Screen 1: Entry -->
    <div id="entry-screen" class="screen active">
        <div class="container">
            <h1>Freeform Number Game</h1>
            <button id="host-button">Create Game</button>
            <hr>
            <input type="text" id="name-input" placeholder="Your Name" maxlength="15"><br><br>
            <input type="text" id="room-input" placeholder="Room Code" pattern="[0-9]*"><br><br>
            <button id="join-button">Join Game</button>
        </div>
    </div>

    <!-- Screen 2: Host Dashboard -->
    <div id="host-dashboard" class="screen">
        <div class="container">
            <h1>Host Dashboard</h1>
            <h2>Room Code: <span id="room-code"></span></h2>
            <button id="next-question-button">Start Next Question</button>
            
            <div id="host-results-view">
                <h3>Results</h3>
                <h4>Correct Answer: <span id="correct-answer"></span></h4>
                <table id="answers-table"><thead><tr><th>Player</th><th>Answer</th></tr></thead><tbody></tbody></table>
            </div>

            <h3>Scores</h3>
            <table id="scores-table"><thead><tr><th>Player</th><th>Score</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <!-- Screen 3: Player View -->
    <div id="player-view" class="screen">
        <div class="container">
            <h2 id="player-name-display"></h2>
            <div id="player-question-view" class="hidden">
                <div id="timer-display"></div>
                <p id="question-text"></p>
                <div id="answer-display"></div>
                <div class="numpad">
                    <button>1</button><button>2</button><button>3</button>
                    <button>4</button><button>5</button><button>6</button>
                    <button>7</button><button>8</button><button>9</button>
                    <button id="numpad-clear">C</button><button>0</button>
                </div>

                <!-- Separate Submit button -->
                <div style="max-width:300px;margin:0 auto;">
                    <button id="submit-button">Submit</button>
                </div>
            </div>
            <div id="player-waiting-view">
                <h2>Waiting for the next question...</h2>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // --- State Variables ---
        let myRoomCode = '';
        let timerInterval;

        // --- Screen Elements ---
        const screens = document.querySelectorAll('.screen');
        const entryScreen = document.getElementById('entry-screen');
        const hostDashboard = document.getElementById('host-dashboard');
        const playerView = document.getElementById('player-view');
        
        // --- Host Elements ---
        const hostButton = document.getElementById('host-button');
        const roomCodeDisplay = document.getElementById('room-code');
        const nextQuestionButton = document.getElementById('next-question-button');
        const hostResultsView = document.getElementById('host-results-view');
        const correctAnswerDisplay = document.getElementById('correct-answer');
        const answersTableBody = document.querySelector('#answers-table tbody');
        const scoresTableBody = document.querySelector('#scores-table tbody');

        // --- Player Elements ---
        const joinButton = document.getElementById('join-button');
        const nameInput = document.getElementById('name-input');
        const roomInput = document.getElementById('room-input');
        const playerNameDisplay = document.getElementById('player-name-display');
        const playerQuestionView = document.getElementById('player-question-view');
        const playerWaitingView = document.getElementById('player-waiting-view');
        const timerDisplay = document.getElementById('timer-display');
        const questionText = document.getElementById('question-text');
        const answerDisplay = document.getElementById('answer-display');
        const numpadButtons = document.querySelectorAll('.numpad button');
        const submitButton = document.getElementById('submit-button');
        
        // --- Utility Functions ---
        function showScreen(screenId) {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // --- Event Listeners ---
        hostButton.addEventListener('click', () => socket.emit('host:create'));
        joinButton.addEventListener('click', () => {
            if (nameInput.value && roomInput.value) {
                socket.emit('player:join', roomInput.value, nameInput.value);
            }
        });
        nextQuestionButton.addEventListener('click', () => {
             hostResultsView.style.display = 'none'; // Hide old results
            socket.emit('host:nextQuestion', myRoomCode);
        });

        // Numpad buttons: append digits or clear
        numpadButtons.forEach(button => {
            button.addEventListener('click', () => {
                const id = button.id;
                const value = button.textContent.trim();

                if (id === 'numpad-clear') {
                    answerDisplay.textContent = '';
                    return;
                }
                // Append numeric keys only
                if (!isNaN(parseInt(value, 10))) {
                    answerDisplay.textContent += value;
                }
            });
        });

        // Separate submit button
        submitButton.addEventListener('click', () => {
            if (answerDisplay.textContent) {
                playerQuestionView.classList.add('hidden');
                playerWaitingView.classList.remove('hidden');
                socket.emit('player:submitAnswer', myRoomCode, answerDisplay.textContent);
            }
        });

        // --- Socket Event Handlers ---
        socket.on('server:roomCreated', (roomCode) => {
            myRoomCode = roomCode;
            roomCodeDisplay.textContent = roomCode;
            hostResultsView.style.display = 'none';
            showScreen('host-dashboard');
        });

        socket.on('server:joined', (roomCode) => {
            myRoomCode = roomCode;
            playerNameDisplay.textContent = nameInput.value;
            playerWaitingView.classList.remove('hidden');
            playerQuestionView.classList.add('hidden');
            showScreen('player-view');
        });
        
        socket.on('server:updatePlayers', (players) => {
            scoresTableBody.innerHTML = '';
            players.forEach(p => {
                const row = scoresTableBody.insertRow();
                row.insertCell(0).textContent = p.name;
                row.insertCell(1).textContent = p.score;
            });
        });
        
        // Accept payload { question, timer } from host
        socket.on('server:newQuestion', (payload) => {
            // This is for everyone (host and players)
            nextQuestionButton.disabled = true;

            // Player specific actions
            if (playerView.classList.contains('active')) {
                questionText.textContent = payload.question;
                answerDisplay.textContent = '';
                playerWaitingView.classList.add('hidden');
                playerQuestionView.classList.remove('hidden');

                // Timer logic
                let timeLeft = payload.timer || 15;
                timerDisplay.textContent = timeLeft;
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        // No need to submit, server handles timeout
                    }
                }, 1000);
            }
        });

        socket.on('server:showResults', (results) => {
            correctAnswerDisplay.textContent = results.correctAnswer;

            // Update answers table
            answersTableBody.innerHTML = '';
            results.playerAnswers.forEach(p => {
                const row = answersTableBody.insertRow();
                row.insertCell(0).textContent = p.name;
                row.insertCell(1).textContent = p.answer;
            });

            // Update scores table
            scoresTableBody.innerHTML = '';
            results.scores.forEach(p => {
                const row = scoresTableBody.insertRow();
                row.insertCell(0).textContent = p.name;
                row.insertCell(1).textContent = p.score;
            });

            hostResultsView.style.display = 'block';
            nextQuestionButton.disabled = false;
        });

        socket.on('server:gameOver', () => {
            alert('The game is over!');
        });

        socket.on('server:error', (message) => alert(message));
    </script>
</body>
</html>
